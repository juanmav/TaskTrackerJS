/*! tasktrackerjs 2015-06-19 */
function initPersistence(a){if(a.isImmutable)return a;a.isImmutable=function(a){return"id"==a},a.defineProp=function(a,b,c,d){"function"==typeof a.__defineSetter__&&"function"==typeof a.__defineGetter__?(a.__defineSetter__(b,function(a){c(a)}),a.__defineGetter__(b,function(){return d()})):Object.defineProperty(a,b,{get:d,set:function(a){c(a)},enumerable:!0,configurable:!0})},a.set=function(b,c,d){if(a.isImmutable(c))throw new Error("immutable field: "+c);b[c]=d},a.get=function(a,b){return 1==arguments.length?a:a[b]},function(){function c(a){return u[a]}function d(a){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={},this.conn=a}function e(d){function f(c,e){var f=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"obj",optional:!0,check:function(a){return a},defaultValue:{}}]);if(i.isMixin)throw new Error("Cannot instantiate mixin");c=f.session,e=f.obj;var h=this;this.id=e.id||a.createUUID(),this._new=!0,this._type=d,this._dirtyProperties={},this._data={},this._data_obj={},this._session=c||a,this.subscribers={};for(var j in i.fields)!function(){if(i.fields.hasOwnProperty(j)){var b=j;a.defineProp(h,b,function(a){var d=h._data[b];(d!==a||d&&a&&d.getTime&&a.getTime)&&(h._data[b]=a,h._dirtyProperties[b]=d,h.triggerEvent("set",h,b,a),h.triggerEvent("change",h,b,a),c.propertyChanged(h,b,d,a))},function(){return h._data[b]}),h._data[j]=g(i.fields[j])}}();for(var k in i.hasOne)i.hasOne.hasOwnProperty(k)&&!function(){var b=k,d=i.hasOne[k].type.meta.isMixin?b+"_class":null;a.defineProp(h,b,function(a){var e=h._data[b],f=h._data_obj[b]||c.trackedObjects[h._data[b]];if(null==a?(h._data[b]=null,h._data_obj[b]=void 0,d&&(h[d]="")):a.id?(h._data[b]=a.id,h._data_obj[b]=a,d&&(h[d]=a._type),c.add(a),c.add(h)):h._data[b]=a,h._dirtyProperties[b]=e,h.triggerEvent("set",h,b,a),h.triggerEvent("change",h,b,a),i.hasOne[b].inverseProperty){var g=h[b];if(g){var j=g[i.hasOne[b].inverseProperty];j.list&&j._filter&&j.triggerEvent("change",h,b,a)}if(f){console.log("OldValue",f);var j=f[i.hasOne[b].inverseProperty];j.list&&j._filter&&j.triggerEvent("change",h,b,a)}}},function(){if(h._data[b]){if(void 0!==h._data_obj[b])return h._data_obj[b];if(h._data[b]&&c.trackedObjects[h._data[b]])return h._data_obj[b]=c.trackedObjects[h._data[b]],h._data_obj[b];throw new Error("Property '"+b+"' of '"+i.name+"' with id: "+h._data[b]+" not fetched, either prefetch it or fetch it manually.")}return null})}();for(var k in i.hasMany)i.hasMany.hasOwnProperty(k)&&!function(){var b=k;i.hasMany[b].manyToMany?a.defineProp(h,b,function(c){if(!c||!c._items)throw new Error("Not yet supported.");for(var d=c._items,e=0;e<d.length;e++)a.get(h,b).add(d[e])},function(){if(h._data[b])return h._data[b];var d=i.hasMany[b],e=d.type.meta,f=e.hasMany[d.inverseProperty],g=d.mixin?d.mixin.meta.name:i.name,j=f.mixin?f.mixin.meta.name:e.name,k=new a.ManyToManyDbQueryCollection(c,e.name);return k.initManyToMany(h,b),k._manyToManyFetch={table:d.tableName,prop:g+"_"+b,inverseProp:j+"_"+d.inverseProperty,id:h.id},h._data[b]=k,c.uniqueQueryCollection(k)}):a.defineProp(h,b,function(c){if(!c||!c._items)throw new Error("Not yet supported.");for(var d=c._items,e=0;e<d.length;e++)a.get(h,b).add(d[e])},function(){if(h._data[b])return h._data[b];var d=c.uniqueQueryCollection(new a.DbQueryCollection(c,i.hasMany[b].type.meta.name).filter(i.hasMany[b].inverseProperty,"=",h));return h._data[b]=d,d})}();this.initialize&&this.initialize();for(var l in e)e.hasOwnProperty(l)&&"id"!==l&&a.set(h,l,e[l])}function h(b,d,e,f){var g=(b._session,[]),i=c(b._type),j=i.fields;for(var k in e)e.hasOwnProperty(k)&&g.push(k);var l=[],m=[];g.forEach(function(a){e[a]!==!0||i.hasMany[a]?m.push(a):l.push(a)});var n=b._data,o={};l.forEach(function(c){"id"===c?o.id=b.id:o[c]=i.hasOne[c]?n[c]?{id:n[c]}:null:a.entityValToJson(n[c],j[c])}),g=m.slice(),a.asyncForEach(g,function(c,f){i.hasOne[c]?b.fetch(d,c,function(a){a?h(a,d,e[c],function(a){o[c]=a,f()}):(o[c]=null,f())}):i.hasMany[c]&&a.get(b,c).list(function(b){o[c]=[],a.asyncForEach(b,function(a,f){var a=b.pop();e[c]===!0?(o[c].push({id:a.id}),f()):h(a,d,e[c],function(a){o[c].push(a),f()})},f)})},function(){f(o)})}if(v[d])return v[d];var i=u[d];f.prototype=new k,f.meta=i,f.prototype.equals=function(a){return this.id==a.id},f.prototype.toJSON=function(){var a={id:this.id};for(var b in this._data)this._data.hasOwnProperty(b)&&("object"==typeof this._data[b]&&null!=this._data[b]?void 0!=this._data[b].toJSON&&(a[b]=this._data[b].toJSON()):a[b]=this._data[b]);return a},f.prototype.selectJSON=function(c,d,e){var f=this,g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]);if(c=g.tx,d=g.props,e=g.callback,!c)return void this._session.transaction(function(a){f.selectJSON(a,d,e)});var j={};d.forEach(function(a){for(var b=j,c=a.split("."),d=0;d<c.length;d++){var e=c[d];if(d===c.length-1)if("*"===e){b.id=!0;for(var f in i.fields)i.fields.hasOwnProperty(f)&&(b[f]=!0);for(var f in i.hasOne)i.hasOne.hasOwnProperty(f)&&(b[f]=!0);for(var f in i.hasMany)i.hasMany.hasOwnProperty(f)&&(b[f]=!0)}else if("["===e[0]){e=e.substring(1,e.length-1);var g=e.split(/,\s*/);g.forEach(function(a){b[a]=!0})}else b[e]=!0;else b[e]=b[e]||{},b=b[e]}}),h(this,c,j,e)},f.prototype.fetch=function(c,d,f){var g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"rel",optional:!1,check:b.hasType("string")},{name:"callback",optional:!1,check:b.isCallback()}]);c=g.tx,d=g.rel,f=g.callback;var h=this,j=this._session;if(!c)return void j.transaction(function(a){h.fetch(a,d,f)});if(this._data[d])if(this._data_obj[d])f&&f(this._data_obj[d]);else{var k=i.hasOne[d].type;k.meta.isMixin&&(k=e(this._data[d+"_class"])),k.load(j,c,this._data[d],function(a){h._data_obj[d]=a,f&&f(a)})}else f&&f(null)},f.prototype.markDirty=function(a){this._dirtyProperties[a]=!0},f.all=function(c){var e=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a}]);return c=e.session,c.uniqueQueryCollection(new r(c,d))},f.fromSelectJSON=function(c,d,e,g){function h(b){b||(b=new f(c),e.id&&(b.id=e.id)),c.add(b);var h=[];for(var j in e)if(e.hasOwnProperty(j)){if("id"===j)continue;i.fields[j]?a.set(b,j,a.jsonToEntityVal(e[j],i.fields[j])):(i.hasOne[j]||i.hasMany[j])&&h.push(j)}a.asyncForEach(h,function(f,g){if(i.hasOne[f])i.hasOne[f].type.fromSelectJSON(c,d,e[f],function(c){a.set(b,f,c),g()});else if(i.hasMany[f]){var h=a.get(b,f),j=e[f].slice(0),k=i.hasMany[f].type;h.list(d,function(b){a.asyncForEach(j,function(a,e){k.fromSelectJSON(c,d,a,function(a){for(var c=0;c<b.length;c++)if(b[c].id===a.id)return void e();h.add(a),e()})},function(){g()})})}},function(){g(b)})}var j=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"jsonObj",optional:!1},{name:"callback",optional:!1,check:b.isCallback()}]);return c=j.session,d=j.tx,e=j.jsonObj,g=j.callback,d?("string"==typeof e&&(e=JSON.parse(e)),e?void(e.id?f.load(c,d,e.id,h):h(new f(c))):void g(null)):void c.transaction(function(a){f.fromSelectJSON(c,a,e,g)})},f.load=function(){var c=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"id",optional:!1,check:b.hasType("string")},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);f.findBy(c.session,c.tx,"id",c.id,c.callback)},f.findBy=function(c,d,e,g,h){var i=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"property",optional:!1,check:b.hasType("string")},{name:"value",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);return c=i.session,d=i.tx,e=i.property,g=i.value,h=i.callback,"id"===e&&g in c.trackedObjects?void h(c.trackedObjects[g]):d?void f.all(c).filter(e,"=",g).one(d,function(a){h(a)}):void c.transaction(function(a){f.findBy(c,a,e,g,h)})},f.index=function(a,b){var c=b||{};"string"==typeof a&&(a=[a]),c.columns=a,i.indexes.push(c)},f.hasMany=function(b,c,d){var e=c.meta;if(e.hasMany[d]){var g=i.name+"_"+b+"_"+e.name,h=e.name+"_"+d+"_"+i.name;g>h&&(g=h),i.hasMany[b]={type:c,inverseProperty:d,manyToMany:!0,tableName:g},e.hasMany[d]={type:f,inverseProperty:b,manyToMany:!0,tableName:g},delete i.hasOne[b],delete i.fields[b+"_class"]}else i.hasMany[b]={type:c,inverseProperty:d},e.hasOne[d]={type:f,inverseProperty:b},i.isMixin&&(e.fields[d+"_class"]=a.typeMapper?a.typeMapper.classNameType:"TEXT")},f.hasOne=function(b,c,d){i.hasOne[b]={type:c,inverseProperty:d},c.meta.isMixin&&(i.fields[b+"_class"]=a.typeMapper?a.typeMapper.classNameType:"TEXT")},f.is=function(a){var b=a.meta;if(!b.isMixin)throw new Error("not a mixin: "+a);a.meta.mixedIns=a.meta.mixedIns||[],a.meta.mixedIns.push(i);for(var c in b.fields)b.fields.hasOwnProperty(c)&&(i.fields[c]=b.fields[c]);for(var d in b.hasOne)b.hasOne.hasOwnProperty(d)&&(i.hasOne[d]=b.hasOne[d]);for(var d in b.hasMany)b.hasMany.hasOwnProperty(d)&&(b.hasMany[d].mixin=a,i.hasMany[d]=b.hasMany[d])};for(var j=a.entityDecoratorHooks,l=0;l<j.length;l++)j[l](f);return v[d]=f,f}function f(){if(a.typeMapper&&a.typeMapper.newUuid)return a.typeMapper.newUuid();for(var b=[],c="0123456789ABCDEF",d=0;32>d;d++)b[d]=c.substr(Math.floor(16*Math.random()),1);b[12]="4",b[16]=c.substr(3&b[16]|8,1);var e=b.join("");return e}function g(b){if(a.typeMapper&&a.typeMapper.defaultValue)return a.typeMapper.defaultValue(b);switch(b){case"TEXT":return"";case"BOOL":return!1;default:return-1!==b.indexOf("INT")?0:-1!==b.indexOf("CHAR")?"":null}}function h(a,b){for(var c=a.length,d=0;c>d;d++){var e=a[d];if(e.equals&&e.equals(b))return!0;if(e===b)return!0}return!1}function i(a,b){for(var c=a.length,d=0;c>d;d++){var e=a[d];if(e.equals&&e.equals(b))return void a.splice(d,1);if(e===b)return void a.splice(d,1)}}function j(a,b,c){this.obj=a,this.eventType=b,this.fn=c}function k(){this.subscribers={}}function l(){}function m(a,b){this.left=a,this.right=b}function n(a,b){this.left=a,this.right=b}function o(a,b,c){this.property=a,this.operator=b.toLowerCase(),this.value=c}function p(){}function q(a,b){this.init(a,b,q)}function r(a,b){this.init(a,b,r)}function s(b,c){this.init(b,c,a.ManyToManyDbQueryCollection),this._localAdded=[],this._localRemoved=[]}function t(b){this.init(a,null,t),this._items=b||[]}var u={},v={};a.getEntityMeta=function(){return u},a.trackedObjects={},a.objectsToRemove={},a.objectsRemoved=[],a.globalPropertyListeners={},a.queryCollectionCache={},a.getObjectsToRemove=function(){return this.objectsToRemove},a.getTrackedObjects=function(){return this.trackedObjects},a.entityDecoratorHooks=[],a.flushHooks=[],a.schemaSyncHooks=[],a.debug=!0,a.subscribeToGlobalPropertyListener=function(a,b,c){var d=b+"__"+c;if(d in this.globalPropertyListeners){for(var e=this.globalPropertyListeners[d],f=0;f<e.length;f++)if(e[f]===a)return;this.globalPropertyListeners[d].push(a)}else this.globalPropertyListeners[d]=[a]},a.unsubscribeFromGlobalPropertyListener=function(a,b,c){for(var d=b+"__"+c,e=this.globalPropertyListeners[d],f=0;f<e.length;f++)if(e[f]===a)return void e.splice(f,1)},a.propertyChanged=function(a,b,c,d){if(this.trackedObjects[a.id]){var e=a._type,f=e+"__"+b;if(f in this.globalPropertyListeners)for(var g=this.globalPropertyListeners[f],h=0;h<g.length;h++){var i=g[h],j=a._data;j[b]=c;var k=i._filter.match(j);j[b]=d;var l=i._filter.match(j);k!=l&&i.triggerEvent("change",i,a)}}},a.objectRemoved=function(a){var b=a._type;if(this.queryCollectionCache[b]){var c=this.queryCollectionCache[b];for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];e._filter.match(a)&&e.triggerEvent("change",e,a)}}},a.getMeta=c,d.prototype=a,a.Session=d,a.define=function(a,b){if(u[a])return e(a);var c={name:a,fields:b,isMixin:!1,indexes:[],hasMany:{},hasOne:{}};return u[a]=c,e(a)},a.isDefined=function(a){return!!u[a]},a.defineMixin=function(a,b){var c=this.define(a,b);return c.meta.isMixin=!0,c},a.isTransaction=function(a){return!a||a&&a.executeSql},a.isSession=function(a){return!a||a&&a.schemaSync},a.add=function(a){if(a){if(!this.trackedObjects[a.id]&&(this.trackedObjects[a.id]=a,a._new))for(var b in a._data)a._data.hasOwnProperty(b)&&this.propertyChanged(a,b,void 0,a._data[b]);return this}},a.remove=function(a){return a._new?delete this.trackedObjects[a.id]:(this.objectsToRemove[a.id]||(this.objectsToRemove[a.id]=a),this.objectsRemoved.push({id:a.id,entity:a._type})),this.objectRemoved(a),this},a.clean=function(){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={}},a.asyncForEach=function(a,b,c){function d(){var e=a.pop();b(e,function(b,e){a.length>0?d():c(b,e)})}a=a.slice(0),a.length>0?d():c()},a.asyncParForEach=function(a,b,c){var d=0,e=a.length;0===e&&c();for(var f=0;e>f;f++)b(a[f],function(a,b){d++,d===e&&c(a,b)})},a.jsonToEntityVal=function(a,b){if(!b)return a;switch(b){case"DATE":return"number"==typeof a?new Date(a>1e12?a:1e3*a):null;default:return a}},a.entityValToJson=function(a,b){if(!b)return a;switch(b){case"DATE":return a?(a=new Date(a),Math.round(a.getTime()/1e3)):null;default:return a}},a.dump=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(a){return!a||a&&a.length&&!a.apply},defaultValue:null},{name:"callback",optional:!1,check:b.isCallback(),defaultValue:function(){}}]);if(c=f.tx,d=f.entities,e=f.callback,!d){d=[];for(var g in v)v.hasOwnProperty(g)&&d.push(v[g])}var h={};a.asyncParForEach(d,function(b,d){b.all().list(c,function(e){var f=[];a.asyncParForEach(e,function(d,e){var g={},h=b.meta.fields;for(var i in h)h.hasOwnProperty(i)&&(g[i]=a.entityValToJson(d._data[i],h[i]));var j=b.meta.hasOne;for(var k in j)j.hasOwnProperty(k)&&(g[k]=d._data[k]);var l=b.meta.hasMany,m=[];for(var n in l)l.hasOwnProperty(n)&&m.push(n);a.asyncParForEach(m,function(b,e){var f=a.get(d,b);f.list(c,function(a){g[b]=a.map(function(a){return a.id}),e()})},function(){g.id=d.id,f.push(g),e()})},function(){h[b.meta.name]=f,d()})})},function(){e(h)})},a.load=function(c,d,f){var g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"dump",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=g.tx,d=g.dump,f=g.callback;var h=[],i=this;for(var j in d)if(d.hasOwnProperty(j))for(var k=e(j),l=k.meta.fields,m=d[j],n=0;n<m.length;n++){var o=m[n],p=new k;p.id=o.id;for(var q in o)if(o.hasOwnProperty(q))if(a.isImmutable(q))p[q]=o[q];else if(k.meta.hasMany[q]){var r=k.meta.hasMany[q];if(r.manyToMany&&k.meta.name<r.type.meta.name)continue;var s=a.get(p,q);o[q].length>0&&o[q].forEach(function(a){h.push({Entity:k,coll:s,id:a})})}else a.set(p,q,a.jsonToEntityVal(o[q],l[q]));this.add(p)}i.flush(c,function(){a.asyncForEach(h,function(a,b){a.Entity.load(i,c,a.id,function(c){a.coll.add(c),b()})},function(){i.flush(c,f)})})},a.dumpToJson=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(a){return a&&a.length&&!a.apply},defaultValue:null},{name:"callback",optional:!1,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.entities,e=f.callback,this.dump(c,d,function(a){e(JSON.stringify(a))})},a.loadFromJson=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"jsonDump",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.jsonDump,e=f.callback,this.load(c,JSON.parse(d),e)},a.createUUID=f,j.prototype.unsubscribe=function(){this.obj.removeEventListener(this.eventType,this.fn)},k.prototype.addEventListener=function(a,b){return this.subscribers[a]||(this.subscribers[a]=[]),this.subscribers[a].push(b),new j(this,a,b)},k.prototype.removeEventListener=function(a,b){for(var c=this.subscribers[a],d=0;d<c.length;d++)if(c[d]==b)return this.subscribers[a].splice(d,1),!0;return!1},k.prototype.triggerEvent=function(a){if(this.subscribers[a])for(var b=this.subscribers[a].slice(0),c=0;c<b.length;c++)b[c].apply(null,arguments)},l.prototype.match=function(){return!0},l.prototype.makeFit=function(){},l.prototype.makeNotFit=function(){},l.prototype.toUniqueString=function(){return"NULL"},l.prototype.subscribeGlobally=function(){},l.prototype.unsubscribeGlobally=function(){},m.prototype.match=function(a){return this.left.match(a)&&this.right.match(a)},m.prototype.makeFit=function(a){this.left.makeFit(a),this.right.makeFit(a)},m.prototype.makeNotFit=function(a){this.left.makeNotFit(a),this.right.makeNotFit(a)},m.prototype.toUniqueString=function(){return this.left.toUniqueString()+" AND "+this.right.toUniqueString()},m.prototype.subscribeGlobally=function(a,b){this.left.subscribeGlobally(a,b),this.right.subscribeGlobally(a,b)},m.prototype.unsubscribeGlobally=function(a,b){this.left.unsubscribeGlobally(a,b),this.right.unsubscribeGlobally(a,b)},n.prototype.match=function(a){return this.left.match(a)||this.right.match(a)},n.prototype.makeFit=function(a){this.left.makeFit(a),this.right.makeFit(a)},n.prototype.makeNotFit=function(a){this.left.makeNotFit(a),this.right.makeNotFit(a)},n.prototype.toUniqueString=function(){return this.left.toUniqueString()+" OR "+this.right.toUniqueString()},n.prototype.subscribeGlobally=function(a,b){this.left.subscribeGlobally(a,b),this.right.subscribeGlobally(a,b)},n.prototype.unsubscribeGlobally=function(a,b){this.left.unsubscribeGlobally(a,b),this.right.unsubscribeGlobally(a,b)},o.prototype.match=function(b){var c=this.value,d=a.get(b,this.property);switch(c&&c.getTime&&(c=1e3*Math.round(c.getTime()/1e3),d&&d.getTime&&(d=1e3*Math.round(d.getTime()/1e3))),this.operator){case"=":return d===c;case"!=":return d!==c;case"<":return c>d;case"<=":return c>=d;case">":return d>c;case">=":return d>=c;case"in":return h(c,d);case"not in":return!h(c,d)}},o.prototype.makeFit=function(b){if("="!==this.operator)throw new Error("Sorry, can't perform makeFit for other filters than =");a.set(b,this.property,this.value)},o.prototype.makeNotFit=function(b){if("="!==this.operator)throw new Error("Sorry, can't perform makeNotFit for other filters than =");a.set(b,this.property,null)},o.prototype.subscribeGlobally=function(b,c){a.subscribeToGlobalPropertyListener(b,c,this.property)},o.prototype.unsubscribeGlobally=function(b,c){a.unsubscribeFromGlobalPropertyListener(b,c,this.property)},o.prototype.toUniqueString=function(){var a=this.value;return a&&a._type&&(a=a.id),this.property+this.operator+a},a.NullFilter=l,a.AndFilter=m,a.OrFilter=n,a.PropertyFilter=o,a.uniqueQueryCollection=function(a){var b=a._entityName;if(a._items)return a;this.queryCollectionCache[b]||(this.queryCollectionCache[b]={});var c=a.toUniqueString();return this.queryCollectionCache[b][c]||(this.queryCollectionCache[b][c]=a),this.queryCollectionCache[b][c]},p.prototype=new k,p.prototype.oldAddEventListener=p.prototype.addEventListener,p.prototype.setupSubscriptions=function(){this._filter.subscribeGlobally(this,this._entityName)},p.prototype.teardownSubscriptions=function(){this._filter.unsubscribeGlobally(this,this._entityName)},p.prototype.addEventListener=function(a,b){var c=this,d=this.oldAddEventListener(a,b);return 1===this.subscribers[a].length&&this.setupSubscriptions(),d.oldUnsubscribe=d.unsubscribe,d.unsubscribe=function(){this.oldUnsubscribe(),0===c.subscribers[a].length&&c.teardownSubscriptions()},d},p.prototype.persistQueries=function(){return[]},p.prototype.init=function(b,c,d){this._filter=new l,this._orderColumns=[],this._prefetchFields=[],this._entityName=c,this._constructor=d,this._limit=-1,this._skip=0,this._reverse=!1,this._session=b||a,this.subscribers={}},p.prototype.toUniqueString=function(){var a=this._constructor.name+": "+this._entityName;a+="|Filter:";var b=[];a+=this._filter.toUniqueString(),a+="|Values:";for(var c=0;c<b.length;c++)a+=b+"|^|";a+="|Order:";for(var c=0;c<this._orderColumns.length;c++){var d=this._orderColumns[c];a+=d[0]+", "+d[1]+", "+d[2]}a+="|Prefetch:";for(var c=0;c<this._prefetchFields.length;c++)a+=this._prefetchFields[c];return a+="|Limit:",a+=this._limit,a+="|Skip:",a+=this._skip,a+="|Reverse:",a+=this._reverse},p.prototype.clone=function(a){var b=new this._constructor(this._session,this._entityName);if(b._filter=this._filter,b._prefetchFields=this._prefetchFields.slice(0),b._orderColumns=this._orderColumns.slice(0),b._limit=this._limit,b._skip=this._skip,b._reverse=this._reverse,a){var c={};for(var d in this.subscribers)this.subscribers.hasOwnProperty(d)&&(c[d]=this.subscribers[d].slice(0));b.subscribers=c}else b.subscribers=this.subscribers;return b},p.prototype.filter=function(a,b,c){var d=this.clone(!0);d._filter=new m(this._filter,new o(a,b,c));var e=this._session;return d=e.uniqueQueryCollection(d),e.uniqueQueryCollection(d)},p.prototype.or=function(a){var b=this.clone(!0);return b._filter=new n(this._filter,a),this._session.uniqueQueryCollection(b)},p.prototype.and=function(a){var b=this.clone(!0);return b._filter=new m(this._filter,a),this._session.uniqueQueryCollection(b)},p.prototype.order=function(a,b,c){b=void 0===b?!0:b,c=void 0===c?!0:c;var d=this.clone();return d._orderColumns.push([a,b,c]),this._session.uniqueQueryCollection(d)},p.prototype.limit=function(a){var b=this.clone();return b._limit=a,this._session.uniqueQueryCollection(b)},p.prototype.skip=function(a){var b=this.clone();return b._skip=a,this._session.uniqueQueryCollection(b)},p.prototype.reverse=function(){var a=this.clone();return a._reverse=!0,this._session.uniqueQueryCollection(a)},p.prototype.prefetch=function(a){var b=this.clone();return b._prefetchFields.push(a),this._session.uniqueQueryCollection(b)},p.prototype.selectJSON=function(c,d,f){var g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]),h=this._session,i=this;if(c=g.tx,d=g.props,f=g.callback,!c)return void h.transaction(function(a){i.selectJSON(a,d,f)});e(this._entityName);this.list(function(b){var e=[];a.asyncForEach(b,function(a,b){a.selectJSON(c,d,function(a){e.push(a),b()})},function(){f(e)})})},p.prototype.add=function(a){if(!a.id||!a._type)throw new Error("Cannot add object of non-entity type onto collection.");this._session.add(a),this._filter.makeFit(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},p.prototype.addAll=function(a){for(var b=0;b<a.length;b++){var c=a[b];this._session.add(c),this._filter.makeFit(c),this.triggerEvent("add",this,c)}this.triggerEvent("change",this)},p.prototype.remove=function(a){if(!a.id||!a._type)throw new Error("Cannot remove object of non-entity type from collection.");this._filter.makeNotFit(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},p.prototype.each=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"eachFn",optional:!0,check:b.isCallback()}]);c=e.tx,d=e.eachFn,this.list(c,function(a){for(var b=0;b<a.length;b++)d(a[b])})},p.prototype.forEach=p.prototype.each,p.prototype.one=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"oneFn",optional:!1,check:b.isCallback()}]);c=e.tx,d=e.oneFn;this.limit(1).list(c,function(a){d(0===a.length?null:a[0])})},q.prototype=new p,r.prototype=new q,r.prototype.add=function(a){this._session.add(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},r.prototype.remove=function(a){this._session.remove(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},s.prototype=new q,s.prototype.initManyToMany=function(a,b){this._obj=a,this._coll=b},s.prototype.add=function(a){h(this._localAdded,a)||(this._session.add(a),this._localAdded.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},s.prototype.addAll=function(a){for(var b=0;b<a.length;b++){var c=a[b];h(this._localAdded,c)||(this._session.add(c),this._localAdded.push(c),this.triggerEvent("add",this,c))}this.triggerEvent("change",this)},s.prototype.clone=function(){var a=q.prototype.clone.call(this);return a._localAdded=this._localAdded,a._localRemoved=this._localRemoved,a._obj=this._obj,a._coll=this._coll,a},s.prototype.remove=function(a){h(this._localAdded,a)?i(this._localAdded,a):h(this._localRemoved,a)||this._localRemoved.push(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},t.prototype=new p,t.prototype.clone=function(){var a=q.prototype.clone.call(this);return a._items=this._items,a},t.prototype.add=function(a){h(this._items,a)||(this._session.add(a),this._items.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},t.prototype.addAll=function(a){for(var b=0;b<a.length;b++){var c=a[b];h(this._items,c)||(this._session.add(c),this._items.push(c),this.triggerEvent("add",this,c))}this.triggerEvent("change",this)},t.prototype.remove=function(a){for(var b=this._items,c=0;c<b.length;c++)b[c]===a&&(this._items.splice(c,1),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a))},t.prototype.list=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:b.isCallback()}]);d=e.callback,(!d||d.executeSql)&&(d=arguments[1]);for(var f=this._items.slice(0),g=this,h=[],i=0;i<f.length;i++)this._filter.match(f[i])&&h.push(f[i]);return h.sort(function(b,c){for(var d=0;d<g._orderColumns.length;d++){var e=g._orderColumns[d][0],f=g._orderColumns[d][1],h=g._orderColumns[d][2],i=a.get(b,e),j=a.get(c,e);if(h||(i=i.toLowerCase(),j=j.toLowerCase()),j>i)return f?-1:1;if(i>j)return f?1:-1}return 0}),this._skip&&h.splice(0,this._skip),this._limit>-1&&(h=h.slice(0,this._limit)),this._reverse&&h.reverse(),d?void d(h):h},t.prototype.destroyAll=function(a){(!a||a.executeSql)&&(a=arguments[1]),this._items=[],this.triggerEvent("change",this),a&&a()},t.prototype.count=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:b.isCallback()}]);c=e.tx,d=e.callback;var f=this.list();return d?void d(f.length):f.length},a.QueryCollection=p,a.DbQueryCollection=q,a.ManyToManyDbQueryCollection=s,a.LocalQueryCollection=t,a.Observable=k,a.Subscription=j,a.AndFilter=m,a.OrFilter=n,a.PropertyFilter=o}();var b={};return function(){b.getArgs=function(a,b){for(var c=0,d=0,e={};d<b.length;){var f=b[d],g=a[c];if(f.optional)void 0!==g&&f.check(g)?(e[f.name]=g,c++,d++):(void 0!==f.defaultValue&&(e[f.name]=f.defaultValue),d++);else{if(f.check&&!f.check(g))throw new Error("Invalid value for argument: "+f.name+" Value: "+g);e[f.name]=g,d++,c++}}return e},b.hasProperty=function(a){return function(b){return b&&void 0!==b[a]}},b.hasType=function(a){return function(b){return typeof b===a}},b.isCallback=function(){return function(a){return a&&a.apply}}}(),a.argspec=b,a}function config(a,b){function c(b,c,d,e){if(e=e||"",b.trackedObjects[d[e+"id"]])return b.trackedObjects[d[e+"id"]];var f=a.typeMapper,g=a.getMeta(c),h=a.define(c);if(!d[e+"id"])return null;var i=new h(b,void 0,!0);i.id=f.dbValToEntityVal(d[e+"id"],f.idType),i._new=!1;for(var j in d)if(d.hasOwnProperty(j)&&j.substring(0,e.length)===e){var k=j.substring(e.length);"id"!=k&&(i._data[k]=f.dbValToEntityVal(d[j],g.fields[k]||f.idType))}return i}function d(b,c,d){var e=a.getMeta(b._type),g=a.typeMapper,h=[],i=[],j=[],k=[];if(b._new)for(var l in e.fields)e.fields.hasOwnProperty(l)&&(b._dirtyProperties[l]=!0);for(var l in b._dirtyProperties)if(b._dirtyProperties.hasOwnProperty(l)){h.push("`"+l+"`");var m=e.fields[l]||g.idType;i.push(g.entityValToDbVal(b._data[l],m)),j.push(g.outVar("?",m)),k.push("`"+l+"` = "+g.outVar("?",m))}var n=[];for(var l in e.hasMany)e.hasMany.hasOwnProperty(l)&&(n=n.concat(a.get(b,l).persistQueries()));f(c,n,function(){if(!b._new&&0===h.length)return void(d&&d());if(b._dirtyProperties={},b._new){h.push("id"),i.push(g.entityIdToDbId(b.id)),j.push(g.outIdVar("?"));var a="INSERT INTO `"+b._type+"` ("+h.join(", ")+") VALUES ("+j.join(", ")+")";b._new=!1,c.executeSql(a,i,d,d)}else{var a="UPDATE `"+b._type+"` SET "+k.join(",")+" WHERE id = "+g.outId(b.id);c.executeSql(a,i,d,d)}})}function e(b,c,d){var e=a.getMeta(b._type),g=a.typeMapper,h=[["DELETE FROM `"+b._type+"` WHERE id = "+g.outId(b.id),null]];for(var i in e.hasMany)if(e.hasMany.hasOwnProperty(i)&&e.hasMany[i].manyToMany){var j=e.hasMany[i].tableName;h.push(["DELETE FROM `"+j+"` WHERE `"+e.name+"_"+i+"` = "+g.outId(b.id),null])}f(c,h,d)}function f(b,c,d){for(var e=[],f=3;f<arguments.length;f++)e.push(arguments[f]);a.asyncForEach(c,function(a,c){b.executeSql(a[0],a[1],c,function(a,b){console.log(b.message),c(a,b)})},function(a,b){return b&&d?void d(a,b):void(d&&d.apply(null,e))})}var g=a.argspec;a.typeMapper=b.typeMapper||defaultTypeMapper,a.generatedTables={},a.schemaSync=function(c,d,e){var h=g.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:g.isCallback(),defaultValue:function(){}},{name:"emulate",optional:!0,check:g.hasType("boolean")}]);if(c=h.tx,d=h.callback,e=h.emulate,!c){var i=this;return void this.transaction(function(a){i.schemaSync(a,d,e)})}var j,k,l,m,n=[],o=a.typeMapper,p=a.getEntityMeta();for(var q in p)if(p.hasOwnProperty(q)){if(j=p[q],!j.isMixin){k=[];for(var r in j.fields)j.fields.hasOwnProperty(r)&&k.push([r,j.fields[r]]);for(var s in j.hasOne)j.hasOne.hasOwnProperty(s)&&(l=j.hasOne[s].type.meta,k.push([s,o.idType]),n.push([b.createIndex(j.name,[s]),null]));for(var t=0;t<j.indexes.length;t++)n.push([b.createIndex(j.name,j.indexes[t].columns,j.indexes[t]),null])}for(var s in j.hasMany)if(j.hasMany.hasOwnProperty(s)&&j.hasMany[s].manyToMany&&(m=j.hasMany[s].tableName,!a.generatedTables[m])){var l=j.hasMany[s].type.meta,u=j.hasMany[s].inverseProperty;if(l.hasMany[u].type.meta!=j)continue;var v=j.name+"_"+s,w=l.name+"_"+u;n.push([b.createIndex(m,[v]),null]),n.push([b.createIndex(m,[w]),null]);var x=[[v,o.idType],[w,o.idType]];j.isMixin&&x.push([v+"_class",o.classNameType]),l.isMixin&&x.push([w+"_class",o.classNameType]),n.push([b.createTable(m,x),null]),a.generatedTables[m]=!0}j.isMixin||(k.push(["id",o.idType,"PRIMARY KEY"]),a.generatedTables[j.name]=!0,n.push([b.createTable(j.name,k),null]))}for(var y=a.schemaSyncHooks,t=0;t<y.length;t++)y[t](c);e?d(c):f(c,n,function(a,b){d(c,b)})},a.flush=function(b,c){var f=g.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction},{name:"callback",optional:!0,check:g.isCallback(),defaultValue:null}]);b=f.tx,c=f.callback;var h=this;if(!b)return void this.transaction(function(a){h.flush(a,c)});var i=a.flushHooks;a.asyncForEach(i,function(a,c){a(h,b,c)},function(){var f=[];for(var g in h.trackedObjects)h.trackedObjects.hasOwnProperty(g)&&f.push(h.trackedObjects[g]);var i=[];for(var g in h.objectsToRemove)h.objectsToRemove.hasOwnProperty(g)&&(i.push(h.objectsToRemove[g]),delete h.trackedObjects[g]);if(h.objectsToRemove={},c)a.asyncParForEach(i,function(a,c){e(a,b,c)},function(e,g){return g?c(e,g):void a.asyncParForEach(f,function(a,c){d(a,b,c)},c)});else{for(var j=0;j<f.length;j++)d(f[j],b);for(var j=0;j<i.length;j++)e(i[j],b)}})},a.reset=function(b,c){var d=g.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:g.isCallback(),defaultValue:function(){}}]);b=d.tx,c=d.callback;var e=this;return b?void this.schemaSync(b,function(){function d(){var a=g.pop();b.executeSql("DROP TABLE IF EXISTS `"+a+"`",null,function(){g.length>0?d():f()},f)}function f(b,d){e.clean(),a.generatedTables={},c&&c(b,d)}var g=[];for(var h in a.generatedTables)a.generatedTables.hasOwnProperty(h)&&g.push(h);

g.length>0?d():f()},!0):void e.transaction(function(a){e.reset(a,c)})},a.save=d,a.executeQueriesSeq=f,a.QueryCollection.prototype.persistQueries=function(){return[]};var h=a.QueryCollection.prototype.clone;a.QueryCollection.prototype.clone=function(a){var b=h.call(this,a);return b._additionalJoinSqls=this._additionalJoinSqls.slice(0),b._additionalWhereSqls=this._additionalWhereSqls.slice(0),b._additionalGroupSqls=this._additionalGroupSqls.slice(0),b._manyToManyFetch=this._manyToManyFetch,b};var i=a.QueryCollection.prototype.init;a.QueryCollection.prototype.init=function(a,b,c){i.call(this,a,b,c),this._manyToManyFetch=null,this._additionalJoinSqls=[],this._additionalWhereSqls=[],this._additionalGroupSqls=[]};var j=a.QueryCollection.prototype.toUniqueString;a.QueryCollection.prototype.toUniqueString=function(){var a=j.call(this);a+="|JoinSQLs:";for(var b=0;b<this._additionalJoinSqls.length;b++)a+=this._additionalJoinSqls[b];a+="|WhereSQLs:";for(var b=0;b<this._additionalWhereSqls.length;b++)a+=this._additionalWhereSqls[b];a+="|GroupSQLs:";for(var b=0;b<this._additionalGroupSqls.length;b++)a+=this._additionalGroupSqls[b];return this._manyToManyFetch&&(a+="|ManyToManyFetch:",a+=JSON.stringify(this._manyToManyFetch)),a},a.NullFilter.prototype.sql=function(){return"1=1"},a.AndFilter.prototype.sql=function(a,b,c){return"("+this.left.sql(a,b,c)+" AND "+this.right.sql(a,b,c)+")"},a.OrFilter.prototype.sql=function(a,b,c){return"("+this.left.sql(a,b,c)+" OR "+this.right.sql(a,b,c)+")"},a.PropertyFilter.prototype.sql=function(b,c,d){var e=a.typeMapper,f=c?"`"+c+"`.":"",g=b.fields[this.property]||e.idType;if("="===this.operator&&null===this.value)return f+"`"+this.property+"` IS NULL";if("!="===this.operator&&null===this.value)return f+"`"+this.property+"` IS NOT NULL";if("in"===this.operator){for(var h=this.value,i=[],j=0;j<h.length;j++)i.push("?"),d.push(e.entityValToDbVal(h[j],g));return 0===h.length?"1 = 0":f+"`"+this.property+"` IN ("+i.join(", ")+")"}if("not in"===this.operator){for(var h=this.value,i=[],j=0;j<h.length;j++)i.push("?"),d.push(e.entityValToDbVal(h[j],g));return 0===h.length?"1 = 1":f+"`"+this.property+"` NOT IN ("+i.join(", ")+")"}var k=this.value;return(k===!0||k===!1)&&(k=k?1:0),d.push(e.entityValToDbVal(k,g)),f+"`"+this.property+"` "+this.operator+" "+e.outVar("?",g)},a.DbQueryCollection.prototype.list=function(b,d){function e(a,b,c){var d=[l.inIdVar("`"+b+"`.id")+" AS "+c+"id"];for(var e in a.fields)a.fields.hasOwnProperty(e)&&d.push(l.inVar("`"+b+"`.`"+e+"`",a.fields[e])+" AS `"+c+e+"`");for(var e in a.hasOne)a.hasOne.hasOwnProperty(e)&&d.push(l.inIdVar("`"+b+"`.`"+e+"`")+" AS `"+c+e+"`");return d}var f=g.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:g.isCallback()}]);b=f.tx,d=f.callback;var h=this,i=this._session;if(!b)return void i.transaction(function(a){h.list(a,d)});var j=this._entityName,k=a.getMeta(j),l=a.typeMapper;if(k.isMixin){var m=[];return void a.asyncForEach(k.mixedIns,function(a,c){var d=h.clone();d._entityName=a.name,d.list(b,function(a){m=m.concat(a),c()})},function(){var b=new a.LocalQueryCollection(m);b._orderColumns=h._orderColumns,b._reverse=h._reverse,b.list(null,d)})}var f=[],n=j+"_",o="root",p=e(k,o,n),q="",r=this._additionalWhereSqls.slice(0),s=this._manyToManyFetch;s&&(q+="LEFT JOIN `"+s.table+"` AS mtm ON mtm.`"+s.inverseProp+"` = `root`.`id` ",r.push("mtm.`"+s.prop+"` = "+l.outId(s.id))),q+=this._additionalJoinSqls.join(" ");for(var t=0;t<this._prefetchFields.length;t++){var u=this._prefetchFields[t],v=k.hasOne[u].type.meta;if(v.isMixin)throw new Error("cannot prefetch a mixin");var w=v.name+"_"+u+"_tbl";p=p.concat(e(v,w,u+"_")),q+="LEFT JOIN `"+v.name+"` AS `"+w+"` ON `"+w+"`.`id` = `"+o+"`.`"+u+"` "}var x="WHERE "+[this._filter.sql(k,o,f)].concat(r).join(" AND "),y="SELECT "+p.join(", ")+" FROM `"+j+"` AS `"+o+"` "+q+" "+x;this._additionalGroupSqls.length>0&&(y+=this._additionalGroupSqls.join(" ")),this._orderColumns.length>0&&(y+=" ORDER BY "+this._orderColumns.map(function(a){return(a[2]?"`":"LOWER(`")+n+a[0]+(a[2]?"` ":"`) ")+(a[1]?"ASC":"DESC")}).join(", ")),this._limit>=0&&(y+=" LIMIT "+this._limit),this._skip>0&&(y+=" OFFSET "+this._skip),i.flush(b,function(){b.executeSql(y,f,function(a){var b=[];h._reverse&&a.reverse();for(var e=0;e<a.length;e++){for(var f=a[e],g=c(i,j,f,n),l=0;l<h._prefetchFields.length;l++){var m=h._prefetchFields[l],o=k.hasOne[m].type.meta;g._data_obj[m]=c(i,o.name,f,m+"_"),i.add(g._data_obj[m])}b.push(g),i.add(g)}d(b),h.triggerEvent("list",h,b)})})},a.DbQueryCollection.prototype.destroyAll=function(b,c){var d=g.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:g.isCallback(),defaultValue:function(){}}]);b=d.tx,c=d.callback;var e=this,f=this._session;if(!b)return void f.transaction(function(a){e.destroyAll(a,c)});var h=this._entityName,i=a.getMeta(h),j=a.typeMapper;if(i.isMixin)return void a.asyncForEach(i.mixedIns,function(a){var d=e.clone();d._entityName=a.name,d.destroyAll(b,c)},c);var k="",l=this._additionalWhereSqls.slice(0),m=this._manyToManyFetch;m&&(k+="LEFT JOIN `"+m.table+"` AS mtm ON mtm.`"+m.inverseProp+"` = `root`.`id` ",l.push("mtm.`"+m.prop+"` = "+j.outId(m.id))),k+=this._additionalJoinSqls.join(" ");var d=[],n="WHERE "+[this._filter.sql(i,null,d)].concat(l).join(" AND "),o="SELECT id FROM `"+h+"` "+k+" "+n,p="DELETE FROM `"+h+"` "+k+" "+n,q=d.slice(0);f.flush(b,function(){b.executeSql(o,d,function(a){for(var d=0;d<a.length;d++)delete f.trackedObjects[a[d].id],f.objectsRemoved.push({id:a[d].id,entity:h});e.triggerEvent("change",e),b.executeSql(p,q,c,c)},c)})},a.DbQueryCollection.prototype.count=function(b,c){var d=g.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:g.isCallback()}]);b=d.tx,c=d.callback;var e=this,f=this._session;if(b&&!b.executeSql&&(c=b,b=null),!b)return void f.transaction(function(a){e.count(a,c)});var h=this._entityName,i=a.getMeta(h),j=a.typeMapper;if(i.isMixin){var k=0;return void a.asyncForEach(i.mixedIns,function(a,c){var d=e.clone();d._entityName=a.name,d.count(b,function(a){k+=a,c()})},function(){c(k)})}var l="",m=this._additionalWhereSqls.slice(0),n=this._manyToManyFetch;n&&(l+="LEFT JOIN `"+n.table+"` AS mtm ON mtm.`"+n.inverseProp+"` = `root`.`id` ",m.push("mtm.`"+n.prop+"` = "+j.outId(n.id))),l+=this._additionalJoinSqls.join(" ");var d=[],o="WHERE "+[this._filter.sql(i,"root",d)].concat(m).join(" AND "),p="SELECT COUNT(*) AS cnt FROM `"+h+"` AS `root` "+l+" "+o;f.flush(b,function(){b.executeSql(p,d,function(a){c(parseInt(a[0].cnt,10))})})},a.ManyToManyDbQueryCollection.prototype.persistQueries=function(){for(var b=[],c=a.getMeta(this._obj._type),d=c.hasMany[this._coll].type.meta,e=a.typeMapper,f=c.hasMany[this._coll],g=d.hasMany[f.inverseProperty],h=f.mixin?f.mixin.meta.name:c.name,i=g.mixin?g.mixin.meta.name:d.name,j=0;j<this._localAdded.length;j++){var k=[h+"_"+this._coll,i+"_"+f.inverseProperty],l=[e.outIdVar("?"),e.outIdVar("?")],m=[e.entityIdToDbId(this._obj.id),e.entityIdToDbId(this._localAdded[j].id)];f.mixin&&(k.push(h+"_"+this._coll+"_class"),l.push("?"),m.push(c.name)),g.mixin&&(k.push(i+"_"+f.inverseProperty+"_class"),l.push("?"),m.push(d.name)),b.push(["INSERT INTO "+f.tableName+" (`"+k.join("`, `")+"`) VALUES ("+l.join(",")+")",m])}this._localAdded=[];for(var j=0;j<this._localRemoved.length;j++)b.push(["DELETE FROM  "+f.tableName+" WHERE `"+h+"_"+this._coll+"` = "+e.outIdVar("?")+" AND `"+i+"_"+f.inverseProperty+"` = "+e.outIdVar("?"),[e.entityIdToDbId(this._obj.id),e.entityIdToDbId(this._localRemoved[j].id)]]);return this._localRemoved=[],b}}function TaskTrackerModel(){persistence.store.websql.config(persistence,"MyDB10","description",5242880),persistence.debug=!1,persistence.schemaSync(),console.info("--------- SMTaskTracker ---------"),console.info(" Para generar una nueva tarea en curso:"),console.info(" TaskTracker.newTask('Nombre Tarea')"),console.info(" para finalizar una tarea se puede iniciar una nueva tarea o:"),console.info(" ejecutar: TaskTracker.endTask()"),console.info(" Para saber que tarea esta activa:"),console.info(" TaskTracker.getActiveTask()"),console.info(" Para saber el reporte de tareas: "),console.info(" TaskTracker.report()"),console.info(" de una fecha puntual TaskTracker.report('25.12.2015')")}if("undefined"!=typeof exports){exports.createPersistence=function(){return initPersistence({})};var singleton;"function"==typeof exports.__defineGetter__?exports.__defineGetter__("persistence",function(){return singleton||(singleton=exports.createPersistence()),singleton}):Object.defineProperty(exports,"persistence",{get:function(){return singleton||(singleton=exports.createPersistence()),singleton},enumerable:!0,configurable:!0})}else window=window||{},window.persistence=initPersistence(window.persistence||{});"undefined"==typeof JSON&&(JSON={}),JSON.stringify||!function(){function f(a){return 10>a?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toJSON&&(i=i.toJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;f>c;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;f>c;c+=1)d=rep[c],"string"==typeof d&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;c>d;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}();var defaultTypeMapper={idType:"VARCHAR(32)",classNameType:"TEXT",columnType:function(a){switch(a){case"JSON":return"TEXT";case"BOOL":return"INT";case"DATE":return"INT";default:return a}},inVar:function(a){return a},outVar:function(a){return a},outId:function(a){return"'"+a+"'"},dbValToEntityVal:function(a,b){if(null===a||void 0===a)return a;switch(b){case"DATE":return new Date(a>1e12?parseInt(a,10):1e3*parseInt(a,10));case"BOOL":return 1===a||"1"===a;case"INT":return+a;case"BIGINT":return+a;case"JSON":return a?JSON.parse(a):a;default:return a}},entityValToDbVal:function(a,b){return void 0===a||null===a?null:"JSON"===b&&a?JSON.stringify(a):a.id?a.id:"BOOL"===b?"false"===a?0:a?1:0:"DATE"===b||a.getTime?(a=new Date(a),Math.round(a.getTime()/1e3)):"VARCHAR(32)"===b?a.toString():a},inIdVar:function(a){return this.inVar(a,this.idType)},outIdVar:function(a){return this.outVar(a,this.idType)},entityIdToDbId:function(a){return this.entityValToDbVal(a,this.idType)}};"undefined"!=typeof exports?(exports.defaultTypeMapper=defaultTypeMapper,exports.config=config):(window=window||{},window.persistence=window.persistence||{},window.persistence.store=window.persistence.store||{},window.persistence.store.sql={defaultTypeMapper:defaultTypeMapper,config:config});try{window||(window={})}catch(e){window={},exports.console=console}var persistence=window&&window.persistence?window.persistence:{};persistence.store||(persistence.store={}),persistence.store.websql={},persistence.store.websql.config=function(a,b,c,d){var e=null;if(a.transaction=function(a){if(!e)throw new Error("No ongoing database connection, please connect first.");e.transaction(a)},a.db=a.db||{},a.db.implementation="unsupported",a.db.conn=null,window&&window.openDatabase)a.db.implementation="html5";else if(window&&window.google&&google.gears)a.db.implementation="gears";else try{openDatabaseSync&&(a.db.implementation="html5-sync")}catch(f){}if(a.db.html5={},a.db.html5.connect=function(b,c,d){var e={},f=openDatabase(b,"1.0",c,d);return e.transaction=function(b){return f.transaction(function(c){return b(a.db.html5.transaction(c))})},e},a.db.html5.transaction=function(b){var c={};return c.executeSql=function(c,d,e,f){a.debug&&console.log(c,d),b.executeSql(c,d,function(a,b){if(e){for(var c=[],d=0;d<b.rows.length;d++)c.push(b.rows.item(d));e(c)}},f)},c},a.db.html5Sync={},a.db.html5Sync.connect=function(b,c,d){var e={},f=openDatabaseSync(b,"1.0",c,d);return e.transaction=function(b){return f.transaction(function(c){return b(a.db.html5Sync.transaction(c))})},e},a.db.html5Sync.transaction=function(b){var c={};return c.executeSql=function(c,d,e){null==d&&(d=[]),a.debug&&console.log(c,d);var f=b.executeSql(c,d);if(f&&e){for(var g=[],h=0;h<f.rows.length;h++)g.push(f.rows.item(h));e(g)}},c},a.db.gears={},a.db.gears.connect=function(b){var c={},d=google.gears.factory.create("beta.database");return d.open(b),c.transaction=function(b){b(a.db.gears.transaction(d))},c},a.db.gears.transaction=function(b){var c={};return c.executeSql=function(c,d,e){a.debug&&console.log(c,d);var f=b.execute(c,d);if(e){for(var g=[];f.isValidRow();){for(var h={},i=0;i<f.fieldCount();i++)h[f.fieldName(i)]=f.field(i);g.push(h),f.next()}e(g)}},c},a.db.connect=function(b,c,d){return"html5"==a.db.implementation?a.db.html5.connect(b,c,d):"html5-sync"==a.db.implementation?a.db.html5Sync.connect(b,c,d):"gears"==a.db.implementation?a.db.gears.connect(b):void 0},a.store.websql.sqliteDialect={createTable:function(b,c){for(var d=a.typeMapper,e="CREATE TABLE IF NOT EXISTS `"+b+"` (",f=[],g=0;g<c.length;g++){var h=c[g];f.push("`"+h[0]+"` "+d.columnType(h[1])+(h[2]?" "+h[2]:""))}return e+=f.join(", "),e+=")"},createIndex:function(a,b,c){return c=c||{},"CREATE "+(c.unique?"UNIQUE ":"")+"INDEX IF NOT EXISTS `"+a+"__"+b.join("_")+"` ON `"+a+"` ("+b.map(function(a){return"`"+a+"`"}).join(", ")+")"}},a.store.sql.config(a,a.store.websql.sqliteDialect),e=a.db.connect(b,c,d),!e)throw new Error("No supported database found in this browser.")};try{exports.persistence=persistence}catch(e){}TaskTrackerModel.START=!0,TaskTrackerModel.END=!1,TaskTrackerModel.Task=persistence.define("Task",{name:"TEXT",date:"DATE",action:"BOOL"}),TaskTrackerModel.Task.prototype.save=function(){persistence.add(this),persistence.flush()},TaskTrackerModel.prototype.newTask=function(a){this.endTask(),setTimeout(function(){var b=new TaskTrackerModel.Task;b.name=a,b.date=new Date,b.action=!0,b.save()},1e3)},TaskTrackerModel.prototype.endTask=function(){TaskTrackerModel.Task.all().order("date",!1).limit(1).list(function(a){if(a[0]&&a[0].action==TaskTrackerModel.START){var b=new TaskTrackerModel.Task;b.name=a[0].name,b.date=new Date,b.action=TaskTrackerModel.END,b.save(),console.log("Tarea Finalizada")}else console.log("No habia ninguna tarea anterior en curso")})},TaskTrackerModel.prototype.getActiveTask=function(){TaskTrackerModel.Task.all().order("date",!1).limit(1).list(function(a){console.log(a[0]&&a[0].action==TaskTrackerModel.START?"Tarea Activa: "+a[0].name:"No hay tarea en curso")})},TaskTrackerModel.prototype.report=function(a){if(a)console.log("Reporte de la fecha: "+new Date(a.replace(/(\d+)\.(\d+)\.(\d+)/,"$2/$1/$3")));else{var b=new Date((new Date).setHours(0,0,0,0)),c=new Date((new Date).setHours(23,59,59,0));TaskTrackerModel.Task.all().filter("date",">",b).filter("date","<",c).order("name").order("date").list(function(a){console.log("Reporte de hoy"),times=[],a.forEach(function(a){void 0===times[a.name]&&(times[a.name]=[]),times[a.name].push(a.date.getTime())}),console.log("Tarea|Tiempo"),Object.keys(times).forEach(function(a){if(times[a].length%2==0){for(var b=0,c=0;c<=times[a].length-1;c+=2)b=b+times[a][c+1]-times[a][c];console.log(a+" | "+b/3600/1e3)}else console.log(" "),console.log("Tarea en curso: "+a)})})}},TaskTracker=new TaskTrackerModel;